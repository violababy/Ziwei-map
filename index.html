<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç´«å¾®é£›æ˜Ÿè¦–è¦ºå¼•æ“ï¼ˆè³‡æ–™é©…å‹•ï¼‰</title>

  <style>
    body{
      font-family:"Segoe UI", Arial, sans-serif;
      background:#f4f6f8;
      margin:0;
      padding:20px;
    }
    h1{ text-align:center; margin: 8px 0 14px; }
    .hint{
      text-align:center;
      color:#444;
      margin-bottom: 12px;
      font-size: 14px;
    }
    .panel{
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.10);
      padding: 12px;
      overflow-x:auto;
    }
    svg{
      background:#ffffff;
      border-radius:12px;
      max-width:100%;
      overflow: visible;
      display:block;
      margin:0 auto;
    }
    .palace{
      fill:#f9fafb;
      stroke:#333;
      stroke-width:1.5;
      rx:12;
    }
    .palace-text{
      font-size:14px;
      text-anchor:middle;
      dominant-baseline:middle;
      fill:#222;
      font-weight:600;
      user-select:none;
      pointer-events:none;
    }
    .status{
      text-align:center;
      margin-top:10px;
      font-size: 13px;
      color:#666;
      white-space: pre-line;
    }
    .legend{
      display:flex;
      gap:14px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
      margin: 8px 0 2px;
      font-size: 13px;
      color:#333;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      display:inline-block; margin-right:6px;
      vertical-align:middle;
    }
  </style>
</head>

<body>
  <h1>ğŸ”® ç´«å¾®é£›æ˜Ÿè¦–è¦ºå¼•æ“ï¼ˆè³‡æ–™é©…å‹• / å®®å¹²å››åŒ–ï¼‰</h1>
  <div class="hint">ä½ åªè¦æ”¹ Google Sheetï¼Œé€™è£¡æœƒè‡ªå‹•æ›´æ–°ç®­é ­ï¼ˆç¥¿/æ¬Š/ç§‘/å¿Œï¼‰ã€‚</div>

  <div class="legend">
    <span><span class="dot" style="background:#0B5D1E"></span>åŒ–ç¥¿ï¼ˆæ·±ç¶ ï¼‰</span>
    <span><span class="dot" style="background:#0B3D91"></span>åŒ–æ¬Šï¼ˆæ·±è—ï¼‰</span>
    <span><span class="dot" style="background:#4DA3FF"></span>åŒ–ç§‘ï¼ˆæ·ºè—ï¼‰</span>
    <span><span class="dot" style="background:#D11F1F"></span>åŒ–å¿Œï¼ˆç´…ï¼‰</span>
  </div>

  <div class="panel">
    <svg id="board" width="1100" height="800" viewBox="0 0 1100 800" aria-label="Ziwei board">
      <!-- ç®­é ­æ¨£å¼ï¼šç”¨ context-stroke è®“ç®­é ­é¡è‰²è·Ÿç·šä¸€è‡´ -->
      <defs>
        <marker id="arrowHead" viewBox="0 0 10 10" refX="8.5" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="context-stroke" stroke="context-stroke"></path>
        </marker>
      </defs>

      <!-- ç·šæœƒç•«åœ¨æœ€ä¸Šå±¤ï¼›æˆ‘å€‘ç”¨å…©å±¤ï¼šåº•ç·šå±¤ + å®®ä½å±¤ -->
      <g id="linesLayer"></g>
      <g id="palacesLayer">
        <!-- ä¸Šæ’ -->
        <!-- P10 å­å¥³ -->
        <rect class="palace" x="100" y="60" width="180" height="110"></rect>
        <text class="palace-text" x="190" y="115">å­å¥³</text>

        <!-- P11 å¤«å¦» -->
        <rect class="palace" x="320" y="60" width="180" height="110"></rect>
        <text class="palace-text" x="410" y="115">å¤«å¦»</text>

        <!-- P12 å…„å¼Ÿ -->
        <rect class="palace" x="540" y="60" width="180" height="110"></rect>
        <text class="palace-text" x="630" y="115">å…„å¼Ÿ</text>

        <!-- P1 å‘½å®® -->
        <rect class="palace" x="760" y="60" width="180" height="110"></rect>
        <text class="palace-text" x="850" y="115">å‘½å®®</text>

        <!-- å·¦å´ä¸­æ’ -->
        <!-- P9 è²¡å¸› -->
        <rect class="palace" x="100" y="230" width="180" height="110"></rect>
        <text class="palace-text" x="190" y="285">è²¡å¸›</text>

        <!-- P8 ç–¾å„ -->
        <rect class="palace" x="100" y="400" width="180" height="110"></rect>
        <text class="palace-text" x="190" y="455">ç–¾å„</text>

        <!-- å³å´ä¸­æ’ -->
        <!-- P2 çˆ¶æ¯ -->
        <rect class="palace" x="760" y="230" width="180" height="110"></rect>
        <text class="palace-text" x="850" y="285">çˆ¶æ¯</text>

        <!-- P3 ç¦å¾· -->
        <rect class="palace" x="760" y="400" width="180" height="110"></rect>
        <text class="palace-text" x="850" y="455">ç¦å¾·</text>

        <!-- ä¸‹æ’ -->
        <!-- P7 é·ç§» -->
        <rect class="palace" x="100" y="570" width="180" height="110"></rect>
        <text class="palace-text" x="190" y="625">é·ç§»</text>

        <!-- P6 åƒ•å½¹ -->
        <rect class="palace" x="320" y="570" width="180" height="110"></rect>
        <text class="palace-text" x="410" y="625">åƒ•å½¹</text>

        <!-- P5 å®˜ç¥¿ -->
        <rect class="palace" x="540" y="570" width="180" height="110"></rect>
        <text class="palace-text" x="630" y="625">å®˜ç¥¿</text>

        <!-- P4 ç”°å®… -->
        <rect class="palace" x="760" y="570" width="180" height="110"></rect>
        <text class="palace-text" x="850" y="625">ç”°å®…</text>
      </g>
    </svg>

    <div id="status" class="status">ç‹€æ…‹ï¼šç­‰å¾…è¼‰å…¥è³‡æ–™â€¦</div>
  </div>

<script>
/** âœ… ä½ çš„å…©å€‹ Google Sheet CSVï¼ˆä½ å·²æä¾›ï¼‰ **/
const CSV_TRANSFORMS_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTkNreRfwK7wRhPyQF-hSpVYN_tOlne58Ozjofq6vNxiKZSC7Xd2jfyaK6qE0RsjXYI_WWEKDlZaPIk/pub?gid=1520997816&single=true&output=csv";

const CSV_NATAL_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vTkNreRfwK7wRhPyQF-hSpVYN_tOlne58Ozjofq6vNxiKZSC7Xd2jfyaK6qE0RsjXYI_WWEKDlZaPIk/pub?gid=0&single=true&output=csv";

/** âœ… ä½ æŒ‡å®šçš„é¡è‰² **/
const COLOR_MAP = {
  "ç¥¿": "#0B5D1E",     // æ·±ç¶ 
  "æ¬Š": "#0B3D91",     // æ·±è—
  "ç§‘": "#4DA3FF",     // æ·ºè—
  "å¿Œ": "#D11F1F"      // ç´…
};

/** å®®ä½åº§æ¨™ï¼šä»¥ã€Œæ ¼å­ä¸­å¿ƒã€ç•¶ä½œåŸºæº–é»ï¼ˆä½†ç•«ç·šæœƒè‡ªå‹•é¿é–‹æ–‡å­—ï¼Œæœƒç¸®çŸ­ç·šæ®µï¼‰ **/
const PALACE_BOX = {
  P1:  { name:"å‘½å®®", x:760, y:60,  w:180, h:110 },
  P2:  { name:"çˆ¶æ¯", x:760, y:230, w:180, h:110 },
  P3:  { name:"ç¦å¾·", x:760, y:400, w:180, h:110 },
  P4:  { name:"ç”°å®…", x:760, y:570, w:180, h:110 },
  P5:  { name:"å®˜ç¥¿", x:540, y:570, w:180, h:110 },
  P6:  { name:"åƒ•å½¹", x:320, y:570, w:180, h:110 },
  P7:  { name:"é·ç§»", x:100, y:570, w:180, h:110 },
  P8:  { name:"ç–¾å„", x:100, y:400, w:180, h:110 },
  P9:  { name:"è²¡å¸›", x:100, y:230, w:180, h:110 },
  P10: { name:"å­å¥³", x:100, y:60,  w:180, h:110 },
  P11: { name:"å¤«å¦»", x:320, y:60,  w:180, h:110 },
  P12: { name:"å…„å¼Ÿ", x:540, y:60,  w:180, h:110 }
};

function setStatus(msg){
  document.getElementById("status").textContent = msg;
}

/** ---------- CSV è§£æï¼ˆæ”¯æ´ä¸€èˆ¬é€—è™Ÿã€å¼•è™Ÿï¼‰ ---------- **/
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i=0; i<text.length; i++){
    const c = text[i];
    const next = text[i+1];

    if (c === '"' ){
      if (inQuotes && next === '"'){ // é€£çºŒé›™å¼•è™Ÿ = è·³è„«
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if (!inQuotes && c === ","){
      row.push(cur.trim());
      cur = "";
      continue;
    }

    if (!inQuotes && (c === "\n" || c === "\r")){
      if (c === "\r" && next === "\n") i++;
      row.push(cur.trim());
      cur = "";
      // å¿½ç•¥ç©ºç™½è¡Œ
      if (row.some(v => v !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += c;
  }

  row.push(cur.trim());
  if (row.some(v => v !== "")) rows.push(row);

  return rows;
}

function rowsToObjects(rows){
  if (!rows || rows.length < 2) return [];
  const header = rows[0].map(h => h.trim());
  const objs = [];
  for (let i=1; i<rows.length; i++){
    const r = rows[i];
    const o = {};
    for (let j=0; j<header.length; j++){
      o[header[j]] = (r[j] ?? "").trim();
    }
    objs.push(o);
  }
  return objs;
}

async function fetchCSV(url){
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`æŠ“å–å¤±æ•—ï¼š${res.status} ${res.statusText}`);
  const text = await res.text();
  return rowsToObjects(parseCSV(text));
}

/** ---------- è³‡æ–™ç†è§£ï¼šå››åŒ–å°ç…§è¡¨ï¼ˆå®®å¹² -> ç¥¿æ¬Šç§‘å¿Œ -> æ˜Ÿæ›œï¼‰ ---------- **/
function buildStemTransformMap(transformRows){
  // å¸¸è¦‹æ¬„ä½åç¨±ï¼šå®®å¹² / å¤©å¹² / å¹²
  // å¸¸è¦‹å››åŒ–æ¬„ä½ï¼šåŒ–ç¥¿/ç¥¿ã€ç”Ÿå¹´ç¥¿(ä¸ä¸€å®š)ã€åŒ–æ¬Š/æ¬Šã€åŒ–ç§‘/ç§‘ã€åŒ–å¿Œ/å¿Œ
  const pick = (obj, keys) => keys.map(k => obj[k]).find(v => v !== undefined && v !== "") ?? "";

  const map = {}; // stem -> {ç¥¿: æ˜Ÿ, æ¬Š: æ˜Ÿ, ç§‘: æ˜Ÿ, å¿Œ: æ˜Ÿ}

  for (const r of transformRows){
    const stem = pick(r, ["å®®å¹²","å¤©å¹²","å¹²","å®®ä½å¤©å¹²","å®®ä½å¹²"]).trim();
    if (!stem) continue;

    const lu  = pick(r, ["åŒ–ç¥¿","ç¥¿","å››åŒ–ç¥¿","ç¦„"]);
    const quan= pick(r, ["åŒ–æ¬Š","æ¬Š","å››åŒ–æ¬Š"]);
    const ke  = pick(r, ["åŒ–ç§‘","ç§‘","å››åŒ–ç§‘"]);
    const ji  = pick(r, ["åŒ–å¿Œ","å¿Œ","å››åŒ–å¿Œ"]);

    map[stem] = {
      "ç¥¿": (lu||"").trim(),
      "æ¬Š": (quan||"").trim(),
      "ç§‘": (ke||"").trim(),
      "å¿Œ": (ji||"").trim()
    };
  }
  return map;
}

/** ---------- è³‡æ–™ç†è§£ï¼šæœ¬å‘½ç›¤ï¼ˆP1~P12 çš„å®®å¹² + æ˜Ÿæ›œè½é»ï¼‰ ---------- **/
function normalizeStarName(s){
  return (s || "").trim().replace(/\s+/g,"");
}

function buildNatalIndex(natalRows){
  // ä½ æœ¬å‘½ç›¤ tab ç›®å‰æ¬„ä½çœ‹èµ·ä¾†æœ‰ï¼š
  // A: å®®ä½ä»£ç¢¼, B: å®®ä½, C: å®®å¹², D: èº«å®®, E..: ä¸»æ˜Ÿ/å‰æ˜Ÿ/ç…æ˜Ÿ/ä¹™ç´šæ˜Ÿ/ç”Ÿå¹´ç¥¿æ¬Šç§‘å¿Œ/è‡ªåŒ–...
  // æˆ‘å€‘è¦ï¼š
  // 1) palaceStem[P#] = å®®å¹²
  // 2) starToPalace[æ˜Ÿå] = P#ï¼ˆæ˜Ÿåœ¨å“ªå€‹å®®ï¼‰
  const palaceStem = {};
  const starToPalace = {};

  // æ‰¾ã€Œå®®ä½ä»£ç¢¼ã€æ¬„ä½åç¨±
  const codeKeyCandidates = ["å®®ä½ä»£ç¢¼","å®®ä½ä»£ç ","ä»£ç¢¼","ä»£å·","P","ä»£ç¢¼(P)"];
  const stemKeyCandidates = ["å®®å¹²","å¤©å¹²","å¹²"];
  const palaceNameCandidates = ["å®®ä½","å®®å","å®®ä½åç¨±","å®«ä½"];

  const headerKeys = natalRows.length ? Object.keys(natalRows[0]) : [];

  const findKey = (cands) => cands.find(k => headerKeys.includes(k)) || "";

  const codeKey = findKey(codeKeyCandidates) || "å®®ä½ä»£ç¢¼";
  const stemKey = findKey(stemKeyCandidates) || "å®®å¹²";

  // æ˜Ÿæ›œæ¬„ï¼šæ’é™¤å¹¾å€‹åŸºæœ¬æ¬„ä½ï¼Œå…¶é¤˜éƒ½ç•¶æ˜Ÿæ›œæ¬„æƒæ
  const exclude = new Set([codeKey, stemKey, findKey(palaceNameCandidates), "èº«å®®"]);
  const starKeys = headerKeys.filter(k => !exclude.has(k));

  for (const r of natalRows){
    const code = (r[codeKey] || "").trim();
    if (!code || !/^P\d+$/i.test(code)) continue;

    const stem = (r[stemKey] || "").trim();
    if (stem) palaceStem[code.toUpperCase()] = stem;

    // æƒææ˜Ÿæ›œæ¬„ï¼ŒæŠŠå‡ºç¾çš„æ˜Ÿåç™»è¨˜åˆ° starToPalace
    for (const k of starKeys){
      const v = normalizeStarName(r[k]);
      if (!v) continue;

      // æœ‰äº›æ¬„ä½å¯èƒ½æ˜¯ã€Œå¤«å¦»ã€ã€Œèº«å®®ã€é€™ç¨®éæ˜Ÿåï¼›å…ˆè·³éå¤ªçŸ­æˆ–å«æ‹¬è™Ÿçš„ä¹Ÿå¯ï¼ˆå…ˆä¸éåº¦ç¯©ï¼‰
      // é€™è£¡å…ˆåšæœ€å°å‡è¨­ï¼šåªè¦æ˜¯å­—å°±å¯èƒ½æ˜¯æ˜Ÿ
      starToPalace[v] = code.toUpperCase();
    }
  }

  return { palaceStem, starToPalace, codeKey, stemKey };
}

/** ---------- ç®—ã€Œå®®å¹²å››åŒ–é£›æ˜Ÿã€ï¼šæ¯å®®(å®®å¹²) -> å››åŒ–æ˜Ÿ -> æ˜Ÿæ‰€åœ¨å®® ---------- **/
function computeFlyingTransforms({palaceStem, starToPalace}, stemTransformMap){
  const transforms = []; // {from, to, type, star}

  for (const from of Object.keys(palaceStem)){
    const stem = palaceStem[from];
    const t = stemTransformMap[stem];
    if (!t) continue;

    for (const type of ["ç¥¿","æ¬Š","ç§‘","å¿Œ"]){
      const star = normalizeStarName(t[type]);
      if (!star) continue;

      const to = starToPalace[star];
      if (!to) continue; // æ‰¾ä¸åˆ°é€™é¡†æ˜Ÿè½åœ¨å“ªå®®ï¼Œå…ˆè·³é

      transforms.push({ from, to, type, star });
    }
  }
  return transforms;
}

/** ---------- ç•«ç®­é ­ï¼šç·šç´°ã€ç«¯é»é¿é–‹æ–‡å­—ï¼ˆç¸®çŸ­ç·šæ®µï¼‰ ---------- **/
function centerOfBox(box){
  return { cx: box.x + box.w/2, cy: box.y + box.h/2 };
}

function shortenSegment(x1,y1,x2,y2, startPad=52, endPad=52){
  const dx = x2-x1, dy = y2-y1;
  const len = Math.sqrt(dx*dx + dy*dy) || 1;
  const ux = dx/len, uy = dy/len;

  return {
    sx: x1 + ux*startPad,
    sy: y1 + uy*startPad,
    ex: x2 - ux*endPad,
    ey: y2 - uy*endPad
  };
}

function clearLines(){
  document.getElementById("linesLayer").innerHTML = "";
}

function drawArrow(from, to, type){
  const boxA = PALACE_BOX[from];
  const boxB = PALACE_BOX[to];
  if (!boxA || !boxB) return;

  const {cx:ax, cy:ay} = centerOfBox(boxA);
  const {cx:bx, cy:by} = centerOfBox(boxB);

  // ç«¯é»é¿å­—ï¼šç¸®çŸ­ç·šæ®µï¼ˆè®“ç·šä¸è¦å£“åˆ°æ ¼å­ä¸­å¤®æ–‡å­—ï¼‰
  const seg = shortenSegment(ax,ay,bx,by, 62, 62);

  const svgNS = "http://www.w3.org/2000/svg";
  const line = document.createElementNS(svgNS, "line");
  line.setAttribute("x1", seg.sx);
  line.setAttribute("y1", seg.sy);
  line.setAttribute("x2", seg.ex);
  line.setAttribute("y2", seg.ey);

  const color = COLOR_MAP[type] || "#2b2b2b";
  line.setAttribute("stroke", color);
  line.setAttribute("stroke-width", "2");          // âœ… ç·šè®Šç´°
  line.setAttribute("marker-end", "url(#arrowHead)");
  line.setAttribute("stroke-linecap", "round");
  line.setAttribute("opacity", "0.95");

  document.getElementById("linesLayer").appendChild(line);
}

/** ---------- ä¸»æµç¨‹ï¼šæŠ“å…©å¼µè¡¨ -> ç®—é£›æ˜Ÿ -> ç•«ç·š ---------- **/
async function main(){
  try{
    setStatus("ç‹€æ…‹ï¼šè¼‰å…¥ Google Sheet ä¸­â€¦");

    const [transformRows, natalRows] = await Promise.all([
      fetchCSV(CSV_TRANSFORMS_URL),
      fetchCSV(CSV_NATAL_URL)
    ]);

    const stemTransformMap = buildStemTransformMap(transformRows);
    const natalIndex = buildNatalIndex(natalRows);

    const transforms = computeFlyingTransforms(natalIndex, stemTransformMap);

    clearLines();
    for (const t of transforms){
      drawArrow(t.from, t.to, t.type);
    }

    // é¡¯ç¤ºæ‘˜è¦ï¼šå¹«ä½ æª¢æŸ¥æ˜¯ä¸æ˜¯æœ‰è®€åˆ°è³‡æ–™
    const missingStem = Object.keys(natalIndex.palaceStem).length === 0;
    const missingMap = Object.keys(stemTransformMap).length === 0;

    let msg = `âœ… å·²å®Œæˆï¼šç•«å‡º ${transforms.length} æ¢ã€Œå®®å¹²å››åŒ–ã€é£›ç·š\n`;
    msg += `æœ¬å‘½ç›¤ï¼šè®€åˆ° ${Object.keys(natalIndex.palaceStem).length} å®®çš„å®®å¹²ã€${Object.keys(natalIndex.starToPalace).length} å€‹æ˜Ÿæ›œè½é»\n`;
    msg += `å››åŒ–è¡¨ï¼šè®€åˆ° ${Object.keys(stemTransformMap).length} å€‹å¤©å¹²å°ç…§\n`;

    if (missingStem) msg += "\nâš ï¸ æˆ‘æ²’æœ‰åœ¨æœ¬å‘½ç›¤è¡¨ä¸­æ‰¾åˆ°ã€Œå®®ä½ä»£ç¢¼(P1..P12)ã€æˆ–ã€Œå®®å¹²ã€æ¬„ä½ï¼Œè«‹ç¢ºèªè¡¨é ­åç¨±æ˜¯å¦ç‚ºã€Œå®®ä½ä»£ç¢¼ã€ã€Œå®®å¹²ã€ã€‚";
    if (missingMap)  msg += "\nâš ï¸ æˆ‘æ²’æœ‰åœ¨å››åŒ–å°ç…§è¡¨ä¸­æ‰¾åˆ°ã€Œå®®å¹²/å¤©å¹²ã€åŠã€ŒåŒ–ç¥¿/åŒ–æ¬Š/åŒ–ç§‘/åŒ–å¿Œã€æ¬„ä½ï¼Œè«‹ç¢ºèªè¡¨é ­åç¨±ã€‚";

    // è‹¥æŸäº›æ˜Ÿæ‰¾ä¸åˆ°è½å®®ï¼Œä¹Ÿæœƒå°è‡´ç·šæ•¸åå°‘
    msg += "\nï¼ˆè‹¥ç·šæ•¸å¤ªå°‘ï¼šé€šå¸¸æ˜¯å››åŒ–è¡¨çš„æ˜Ÿåèˆ‡æœ¬å‘½ç›¤çš„æ˜Ÿåå¯«æ³•ä¸ä¸€è‡´ï¼Œä¾‹å¦‚å¤šäº†ç©ºæ ¼ã€ç•°é«”å­—ã€‚ï¼‰";

    setStatus(msg);

  }catch(err){
    console.error(err);
    setStatus("âŒ è¼‰å…¥/è§£æå¤±æ•—ï¼š\n" + (err?.message || err));
  }
}

window.addEventListener("load", main);
</script>

</body>
</html>
